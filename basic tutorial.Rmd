---
title: "Moltilevel Model"
output: pdf_document
---

```{r global_options, echo=FALSE, message=FALSE, warning=FALSE,include=FALSE, results='hide'}
# preperation
rm(list = ls())
setwd("/Users/wanghanlin/Desktop/final project")
knitr::opts_chunk$set(
  fig.width=8, fig.height=8,
  echo=FALSE, warning=FALSE, message=FALSE
  )
# loading the font
library(extrafont)
font_import(
  paths = "/System/Library/Fonts/Supplemental",
  prompt = FALSE,
  pattern = "^Arial Narrow"
  )
loadfonts(device = "postscript", quiet = TRUE)
```


```{r get data}
source("get data function.R")
data <- get.data("nation")
```


add the public isolation to the data

1. school and university lock down at Mar $21^{st}$ 2020

2. self-isolation if ill at Mar $12^{th}$ 2020

3. public events forbidden at Mar $24^{th}$ 2020

4. lock down at Mar $24^{th}$ 2020

5. social distance encouraged at Mar $16^{th}$ 2020

6. partial universities reopen after Sept $20^{th}$ 2020 (0.7)
  school and university reopen at Mar $8^{th}$ 2021 (0.3)

7. social distance encouraged end partially at Mar $29^{th}$ 2021

8. public_events partially reopen at May $17^{th}$ 2021





# checking
```{r}
plot.all <- function(
  time.start = '2020-01-06', time.end = "2021-06-04", iter = 500000 # from Jan 6th 2020 to Jun 4th 2021
  ) {
  data.time <- filter(data, date < as.Date(time.end))
  data <- filter(data.time, date > as.Date(time.start))
  
  rt <- epirt(
    formula = R(Nation, date) ~ 1  + 
      schools_universities + self_isolating_if_ill +
      social_distancing_encouraged + lockdown,
    prior = shifted_gamma(
      shape=1/6, scale = 1, shift = log(1.05)/6
    ),
    prior_covariance = decov(
      shape = c(2, rep(0.5, 5)),scale=0.25
    ),
    link = scaled_logit(6.5)
  )
  # the infection model 
  inf <- epiinf(
    gen = EuropeCovid2$si, 
    seed_days = 6L
  )
  
  deaths <- epiobs(
    formula = deaths ~ 1 ,
    i2o = EuropeCovid2$inf2death, 
    prior_intercept = normal(0.1, 0.01),
    link = scaled_logit(0.02)
  )

  args <- list(
    rt=rt, inf=inf, obs=deaths, 
    data=data, seed=12345, refresh=0
  )
  options(mc.cores = parallel::detectCores())

  pr_args <- c(
    args, 
    list(
      algorithm="sampling", iter=1e3, 
      prior_PD=TRUE, control = list(adapt_delta = 0.99)
      )
    )
  fm_prior <- do.call(epim, pr_args)

  p1 <- plot_rt(fm_prior, levels = c(30, 50, 95))
  args$algorithm <- "fullrank"
  args$iter <- iter
  args$tol_rel_obj <- 1e-5
  fm <- do.call(epim, args)
  p2 <- plot_rt(
    fm, step = T, levels = c(30, 50, 95)
    )
  p3 <- plot_obs(
    fm, type = "deaths", step = T, levels = c(30, 50, 95)
    )
  p4 <- plot_infections(
    fm, levels = c(30, 50, 95), step = T
    )
  p5 <- cowplot::plot_grid(
    p1, p2, p3, p4, nrow = 2, labels = LETTERS[1:4]
    )
  return(list(prior = p1, rt = p2, obs = p3, infection = p4))
}
```


```{r fig.cap="prior data until 10 1st, 2020", fig.align='center'}
p <- plot.all(time.start = "2020-01-31", time.end = "2020-10-01", iter = 5000)
p$prior
```

```{r fig.cap="posterior reproduction number until 10 1st, 2020", fig.align='center'}
p$rt
```

```{r fig.cap="fitted death data until 10 1st, 2020", fig.align='center'}
p$obs
```

```{r fig.cap="estimated infection cases until 10 1st, 2020", fig.align='center'}
p$infection
```
